<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#4f46e5" />
    <title>NOI 管理アプリ（PWA・オフライン対応）</title>

    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%234f46e5'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='72' fill='white' font-family='Segoe UI,Roboto,Arial,sans-serif'%3EN%3C/text%3E%3C/svg%3E">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, enableMultiTabIndexedDbPersistence, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Firebase初期化をグローバルスコープで実行
        (async function initFirebaseSafely() {
            window.db = null;
            window.__FIREBASE_INIT_ERROR__ = null;
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyD8ZxI3qto9O_kJxyGoo0cdGP5TKOib6LU",
                    authDomain: "noiapp-b9239.firebaseapp.com",
                    projectId: "noiapp-b9239",
                    storageBucket: "noiapp-b9239.firebasestorage.app",
                    messagingSenderId: "611224601199",
                    appId: "1:611224601199:web:9b5f0f8fecc5ab25a5c39a"
                };
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.serverTimestamp = serverTimestamp;

                // 永続化 (失敗しても無視)
                try {
                    await window.db.enablePersistence({ synchronizeTabs: true });
                } catch (e) {
                    console.warn('Persistence failed:', e);
                }
// 永続化（複数タブ対応 / 失敗しても無視）
                try {
                    await enableMultiTabIndexedDbPersistence(window.db);
                } catch (e) {
                    console.warn('Persistence failed:', e);
                }
        })();
    </script>
    <style>
        :root{ --bg:#0b1220; --panel:#101826; --ink:#f1f5f9; --muted:#a8b3c7; --line:rgba(255,255,255,.14); --brand:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --fs:16px; --focus:#60a5fa; }
        *{box-sizing:border-box}
        body{ margin:0; background:linear-gradient(180deg,var(--bg) 0,#0f172a 40%); color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Helvetica,Arial; font-size:var(--fs); line-height:1.75; letter-spacing:.2px }
        .wrap{max-width:880px;margin:0 auto;padding:14px}
        header{position:sticky;top:0;background:color-mix(in oklab, var(--panel) 92%, transparent);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
        .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .btn{appearance:none;border:1px solid var(--line);border-radius:12px;padding:9px 12px;font-weight:800;color:var(--ink);background:color-mix(in oklab, var(--panel) 88%, transparent)}
        .btn.small{padding:6px 10px;font-size:12px;border-radius:10px}
        .btn.primary{background:color-mix(in oklab, var(--panel) 82%, transparent)}
        .btn.copy{background:color-mix(in oklab, var(--panel) 82%, transparent)}
        .btn.ghost{background:rgba(127,132,152,.16)}
        .btn:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
        .tabs{display:flex;gap:8px;overflow-x:auto;padding:8px 0 6px;margin-top:8px}
        .tab{white-space:nowrap;border:1px solid var(--line);background:color-mix(in oklab, var(--panel) 92%, transparent);padding:10px 12px;border-radius:999px;font-weight:800;color:var(--ink)}
        .tab.active{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(79,70,229,.32)}
        .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:14px;margin-top:12px}
        .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .muted{color:var(--muted);font-size:12px}
        .note{font-size:13px;color:var(--ink);background:color-mix(in oklab, var(--panel) 78%, transparent);border:1px dashed var(--line);padding:10px;border-radius:12px}
        .apps{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:10px}
        .app{background:color-mix(in oklab, var(--panel) 86%, transparent);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;align-items:center;gap:10px;min-height:56px;transition:.2s;font-weight:800;color:var(--ink)}
        .app .badge{font-size:12px;color:#e5e7eb;background:rgba(99,102,241,.18);border:1px solid rgba(99,102,241,.35);padding:3px 10px;border-radius:999px;margin-left:auto}
        .app.selected{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;border-color:transparent;box-shadow:0 8px 24px rgba(79,70,229,.35)}
        textarea, input, select{width:100%; border-radius:12px; border:1px solid var(--line); background:color-mix(in oklab, var(--panel) 92%, transparent); color:var(--ink); padding:10px;}
        textarea#textArea{min-height:220px; line-height:1.85; font-size:16px}
        input::placeholder,textarea::placeholder{color:color-mix(in oklab, var(--ink) 70%, transparent)}
        input:focus-visible, textarea:focus-visible, select:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
        .progress{display:flex;gap:8px;margin-top:6px}
        .dot{width:9px;height:9px;border-radius:999px;background:color-mix(in oklab, var(--ink) 28%, transparent);opacity:.5}
        .dot.on{background:#60a5fa;opacity:1;transform:scale(1.05)}
        .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid var(--line);padding:10px 16px;border-radius:12px;opacity:0;transition:.25s;z-index:200}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .pill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.05)}
        .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:color-mix(in oklab, var(--panel) 86%, transparent);border:1px solid var(--line);padding:2px 6px;border-radius:6px;color:var(--ink)}
        .hr{height:1px;background:var(--line);margin:10px 0}
        .danger{background:color-mix(in oklab, var(--panel) 78%, transparent);color:var(--ink);border:1px solid var(--line)}
        a{color:#93c5fd;text-decoration:underline}
        a:hover{text-decoration:none}
        #tab_qa #qaList .app{ color:#fff; }
        #tab_qa #qaList .app .badge{ color:#e5e7eb; background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.35); }
    </style>
</head>
<body>
    <header>
        <div class="wrap">
            <div class="controls" style="margin-top:6px">
                <button class="btn ghost" id="installBtn">ホームに追加</button>
                <button class="btn" id="protectBtn" title="共有リンクを作成">共有リンク作成</button>
                <button class="btn" id="backupBtn" title="JSONにエクスポート">バックアップ</button>
                <input type="file" id="restoreInput" accept="application/json" style="display:none" />
                <button class="btn" id="restoreBtn">読み込み</button>
            </div>
            <div class="tabs" id="megaTabs" role="tablist" aria-label="メインナビ"></div>
        </div>
    </header>

    <main class="wrap">
        <section class="panel" id="tab_tpl">
            <div class="row" style="justify-content:space-between;align-items:center">
                <div class="row" style="gap:8px">
                    <span class="pill">表示：<strong id="appName"></strong>｜<span id="stepIndex">1</span>/<span id="stepTotal">-</span></span>
                    <span class="muted">（アプリを選択 → カテゴリは上段タブ）</span>
                </div>
            </div>

            <div class="apps" id="appList"></div>
            <div class="hr"></div>

            <input id="stepTitleInput" placeholder="タイトル" style="font-weight:900;font-size:clamp(16px,4.6vw,20px);margin:6px 0 8px;background:transparent" />
            <p class="note" id="explain">ここにテンプレの解説が入ります。</p>

            <div id="ttChoiceBox" style="display:none"></div>

            <textarea id="textArea" readonly></textarea>

            <div class="row" style="justify-content:space-between;margin-top:10px">
                <div class="row">
                    <button class="btn ghost" id="prevBtn">前</button>
                    <button class="btn ghost" id="nextBtn">次</button>
                </div>
                <div class="row">
                    <button class="btn copy" id="copyBtn">この文章をコピー</button>
                    <button class="btn" id="shareBtn">共有…</button>
                </div>
            </div>

            <div class="progress" id="progress"></div>

            <details style="margin-top:10px">
                <summary class="muted">差し替えタグ（任意）</summary>
                <div class="grid2" style="margin-top:8px">
                    <input id="tagName" placeholder="{{name}} → 山本さん" />
                    <input id="tagDate" placeholder="{{date}} → 9/2(火)" />
                    <input id="tagTime" placeholder="{{time}} → 20:00" />
                    <input id="tagLink" placeholder="{{link}} → https://..." />
                </div>
                <div class="muted" style="margin-top:6px">コピー時に <span class="kbd">{{name}}</span> / <span class="kbd">{{date}}</span> / <span class="kbd">{{time}}</span> / <span class="kbd">{{link}}</span> を自動置換します。</div>
            </details>

            <details style="margin-top:10px">
                <summary class="muted">全テンプレへジャンプ／編集</summary>
                <div class="jump" id="jumpList" style="display:flex;gap:8px;flex-wrap:wrap"></div>
                <div id="tplEditor" style="display:none;margin-top:10px">
                    <div class="note">下の一覧は直接編集できます。</div>
                    <div id="tplList"></div>
                    <div class="row" style="margin-top:8px"><button class="btn" id="tplAdd">＋ テンプレを追加</button></div>
                </div>
            </details>
        </section>

        <section class="panel" id="tab_qa" style="display:none">
            <div class="grid2">
                <div class="apps" id="qaAppList"></div>
                <div class="row" style="justify-content:flex-end;gap:8px">
                    <button class="btn" id="qaEditToggle">編集モード</button>
                    <button class="btn primary" id="qaSave" style="display:none">保存</button>
                    <button class="btn danger" id="qaDiscard" style="display:none">取消</button>
                </div>
            </div>
            <div id="qaSegWrap" style="margin-top:8px;display:none"></div>
            <div class="hr"></div>
            <div id="qaList"></div>
            <div id="qaView" style="margin-top:8px"></div>
            <div id="qaEditor" style="display:none;margin-top:10px"></div>
        </section>

        <section class="panel" id="tab_interview" style="display:none">
            <div class="grid2">
                <div class="apps" id="ivAppList"></div>
                <div class="row" style="justify-content:flex-end;gap:8px">
                    <button class="btn" id="ivEditToggle">編集モード</button>
                    <button class="btn primary" id="ivSave" style="display:none">保存</button>
                    <button class="btn danger" id="ivDiscard" style="display:none">取消</button>
                </div>
            </div>

            <div class="hr"></div>
            <h3 style="margin:6px 0">スプレッドシート貼付用 行ジェネレーター</h3>
            <div id="ivFormBox" class="panel">
                <div class="note">ここで入力した回答を<strong>コピー</strong>→スプレッドシートへ貼付（TSV）。<br>最初に <em>列の順番</em> を設定してください（ヘッダー行をそのまま貼り付けOK）。</div>
                <textarea id="ivColsRaw" placeholder="例：日時,氏名,アプリ,希望ジャンル,備考（カンマ/タブ区切りどちらでも可）" style="margin-top:8px;min-height:90px"></textarea>
                <div class="row" style="margin-top:8px"><button class="btn" id="ivColsApply">列を設定</button></div>
            </div>

            <div id="ivEditor" style="display:none;margin-top:10px">
                <input id="ivSheetUrl" placeholder="スプレッドシートURL" />
                <textarea id="ivManual" placeholder="面談マニュアル本文"></textarea>
            </div>
        </section>
    </main>

    <div class="gate" id="gate" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.75);backdrop-filter:blur(6px);z-index:100;">
        <div class="card" style="width:min(520px,92%);background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:16px;">
            <h2 style="margin:4px 0 10px;font-size:18px">アクセス保護</h2>
            <p class="muted" style="margin:0 0 10px">合言葉を入力してください。共有相手にのみ伝えてください。</p>
            <div class="row" style="gap:8px">
                <input id="gatePass" type="password" placeholder="合言葉" aria-label="合言葉" />
                <button class="btn primary" id="gateBtn">解除</button>
            </div>
            <p class="muted" style="margin:10px 0 0">※ オフラインでも動作します。合言葉は端末に保存されません。</p>
        </div>
    </div>

    <div class="toast" id="toast">OK</div>

    <script type="module">
        // Utils
        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));
        const toast = $('#toast');
        const hex = (buf) => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        async function sha256(text){ const data = new TextEncoder().encode(text); const digest = await crypto.subtle.digest('SHA-256', data); return hex(digest); }
        function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1300); }
        function getFromHashOrQuery(name){ const h = new URLSearchParams(location.hash.replace(/^#/,'')).get(name); if(h) return h; return new URLSearchParams(location.search).get(name); }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
        function linkify(s){
            const esc = escapeHtml(String(s||''));
            return esc.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>').replace(/\n/g,'<br>');
        }
        const clone = (o)=> (window.structuredClone ? window.structuredClone(o) : JSON.parse(JSON.stringify(o)));

        // ===== 面談：TikTok / WAVE 共通列 =====
        const IV_DEFAULT_COLUMNS = ['人物像','配信動機','夢や目標','現在の仕事','副業の有無','事務所所属の有無','配信環境の確認','ライブ配信経験','顔出しの有無','配信内容','配信頻度'];

        // ===== TikTok 登録：確認テキスト =====
        const TT_CONFIRM_TEXT = {
            ttba_ok: 'TTBA経由の招待コードの有効期限は24時間のみ。早く登録を行う。',
            agency_ng: [
                '・18歳未満でないか','・他事務所と契約していないか','・フォロワー数が基準を超えていないか','・ダイア数が基準を超えてないか','・外国籍ではないか','・マルチアカウントではないか','・BAN状態ではないか','・退会クール期間中じゃないか'
            ].join('\n')
        };
        const TT_CONFIRM_REQUIRED_KEYS = new Set(['ttba_ok','agency_ng']);

        // ===== Storage / DB model =====
        const KEYS = { db:'noi_db_v2' };
        const DefaultDB = { templates:null, qa:{}, interview:{} };
        let DB = null;

        // ======== Firestore リアルタイム同期 =========
        const SYNC = {
            enabled:false,
            roomId:null,
            clientId:(crypto.randomUUID?.() || Math.random().toString(36).slice(2)),
            unsub:null,
            pushTimer:null
        };

        function saveDB(){
            DB._rev = (DB._rev|0) + 1;
            localStorage.setItem(KEYS.db, JSON.stringify(DB));
            if (SYNC.enabled) queueRemotePush();
        }

        function queueRemotePush(immediate=false){
            if (SYNC.pushTimer) clearTimeout(SYNC.pushTimer);
            SYNC.pushTimer = setTimeout(pushRemote, immediate ? 0 : 400);
        }

        async function pushRemote(){
            if (!window.db || !SYNC.roomId) return;
            try{
                await setDoc(doc(window.db, 'rooms', SYNC.roomId), {
                    db: DB,
                    rev: DB._rev|0,
                    by: SYNC.clientId,
                    updatedAt: window.serverTimestamp()
                }, { merge: true });
            }catch(e){ console.warn('remote push failed', e); }
        }

        function startRealtime(roomId){
            if (!roomId || SYNC.enabled) return;
            if (!window.db) { console.warn('Firestore unavailable; realtime disabled'); return; }

            SYNC.enabled = true;
            SYNC.roomId = roomId;

            const ref = doc(window.db, 'rooms', roomId);
            let initialized = false;

            SYNC.unsub = onSnapshot(
                ref,
                async snap => {
                    const d = snap.data();
                    if (!initialized){
                        initialized = true;
                        if (d && (d.rev|0) > (DB._rev|0)){
                            DB = d.db;
                            localStorage.setItem(KEYS.db, JSON.stringify(DB));
                            renderAll();
                        } else if (!d){
                            await pushRemote();
                        }
                        return;
                    }
                    if (!d) return;
                    if (d.by === SYNC.clientId) return;
                    if ((d.rev|0) <= (DB._rev|0)) return;
                    DB = d.db;
                    localStorage.setItem(KEYS.db, JSON.stringify(DB));
                    renderAll();
                    try{ showToast('他の人の更新を反映しました'); }catch{}
                },
                err => console.warn('onSnapshot', err)
            );
        }
function startRealtimeWhenReady(roomId){
  if (!roomId || SYNC.enabled) return;
  const boot = () => {
    try { startRealtime(roomId); console.log('[SYNC] started', roomId); }
    catch (e) { console.warn('[SYNC] start failed', e); }
  };
  if (window.db) {
    boot();
  } else {
    const timer = setInterval(() => {
      if (window.db) { clearInterval(timer); boot(); }
    }, 150);
    setTimeout(() => clearInterval(timer), 8000);
  }
}
        // ============================================
        // ===== Seed =====
        function seedTemplates(){
            return {
                app:'', group:'スカウト', step:0,
                special:{ ttChoice:null, ttNote:'', ttConfirmRequired:false, ttConfirmText:'' },
                data:{
                    'TikTok':{
                        'スカウト':[
                            {title:'① 初回スカウトDM', explain:'最初に送る定型', text:`{{name}} さん、はじめまして！NOIの山本です。
配信活動に関心がありそうでご連絡しました。
興味があればサポート内容をご案内します！
まずは気軽にお話どうですか？`},
                            {title:'② 反応後の一次返信', explain:'「どんな内容？」への返答', text:`ありがとうございます！
事務所としてTikTok Liveのスタートから収益化まで伴走します。
{{date}} {{time}} に15分だけオンラインで説明、いかがでしょう？`}
                        ],
                        '登録':[ {title:'（選択待ち）', explain:'最初に上の「登録」内フローを選択してください。', text:''} ],
                        'end':[ {title:'⑤ 当日リマインド', explain:'直前リマインド', text:`本日 {{time}} から15分、面談予定です。
Zoom：{{link}}`} ],
                        _ttScenarios:{
                            ttba_ok:[ {title:'TTBA経由＋BackStage登録可', explain:'必要に応じてメモ：{{memo}}', text:`{{name}} さん、TTBA経由のためBackStage登録も進められます。
下記より手続きお願いします：
・エントリーフォーム：{{link}}
不明点あれば気軽にご連絡ください！`} ],
                            sns_ok:[ {title:'SNSスカウト＋BackStage登録可', explain:'必要に応じてメモ：{{memo}}', text:`ご連絡ありがとうございます！
SNS経由スカウトですが、BackStageの登録も可能です。
・登録フォーム：{{link}}
進めてみて、つまづいた所があれば教えてください。`} ],
                            agency_ng:[ {title:'BackStageでagency不可', explain:'対応メモ：{{memo}}', text:`確認したところ、BackStage上でagency登録不可の状態です。
別ルートでの手続きをご案内しますので、{{date}} {{time}} に5〜10分だけお時間いただけますか？`} ],
                            consider:[ {title:'登録検討', explain:'—', text:`前向きにご検討ありがとうございます！
判断材料として、サポート内容や実例を簡潔にまとめます。
{{date}} {{time}} に5分ほどオンラインで補足しますね。`} ],
                            decline:[ {title:'登録辞退', explain:'—', text:`ご連絡ありがとうございます。今回は見送るとのこと承知しました。
また状況が変わった際は、いつでも気軽にご相談ください！`} ]
                        }
                    },
                    '17LIVE':{
                        'スカウト':[
                            {title:'① 初回スカウトDM', explain:'導入', text:`{{name}} さん、こんにちは。17LIVEでの“顔出し配信”に挑戦しませんか？`},
                            {title:'② 反応後の一次返信', explain:'概要', text:`ありがとうございます！イベント活用で露出UP。
{{date}} {{time}} に15分の説明はいかがでしょう？`}
                        ],
                        '登録':[
                            {title:'③ エントリー案内', explain:'フォーム送付', text:`エントリーフォーム：{{link}}`},
                            {title:'④ 面談日程調整', explain:'候補提示', text:`候補日をご確認ください。
・{{date}} {{time}}`}
                        ],
                        'end':[ {title:'⑤ 当日リマインド', explain:'直前案内', text:`本日 {{time}} から面談です。
Zoom：{{link}}`} ]
                    },
                    'ポコチャ':{
                        'スカウト':[
                            {title:'① 初回スカウトDM', explain:'文化前提', text:`{{name}} さん、こんにちは。ポコチャでの配信に興味はありますか？`},
                            {title:'② 反応後の一次返信', explain:'ランク説明', text:`“時間×盛り上がり”でランクが決まります。
{{date}} {{time}} に説明しますね。`}
                        ],
                        '登録':[
                            {title:'③ エントリー案内', explain:'フォーム', text:`フォーム：{{link}}`},
                            {title:'④ 面談日程調整', explain:'候補', text:`候補日：{{date}} {{time}}`}
                        ],
                        'end':[ {title:'⑤ 当日リマインド', explain:'直前', text:`本日 {{time}}、入室リンク：{{link}}`} ]
                    },
                    'BIGOLIVE':{
                        'スカウト':[
                            {title:'① 初回スカウトDM', explain:'幅の広さ', text:`{{name}} さん、こんにちは。BIGOLIVEでの配信サポートを行っています。`},
                            {title:'② 反応後の一次返信', explain:'特性', text:`多言語リスナーが入りやすいです。
{{date}} {{time}} に概要説明どうでしょう？`}
                        ],
                        '登録':[
                            {title:'③ エントリー案内', explain:'フォーム', text:`エントリー：{{link}}`},
                            {title:'④ 面談日程調整', explain:'候補', text:`以下から選択ください。
・{{date}} {{time}}`}
                        ],
                        'end':[ {title:'⑤ 当日リマインド', explain:'直前', text:`本日 {{time}} です。Zoom：{{link}}`} ]
                    },
                    'WAVE':{
                        'スカウト':[
                            {title:'① 初回スカウトDM', explain:'音声特化を強調', text:`{{name}} さん、はじめまして。音声配信アプリ WAVE で活動しませんか？`},
                            {title:'② 反応後の一次返信', explain:'継続しやすさ', text:`WAVEは準備が楽で継続しやすいです。
{{date}} {{time}} にオンラインでいかがでしょう？`}
                        ],
                        '登録':[
                            {title:'③ エントリー案内', explain:'フォーム', text:`エントリー：{{link}}`},
                            {title:'④ 面談日程調整', explain:'候補', text:`候補：{{date}} {{time}}`}
                        ],
                        'end':[ {title:'⑤ 当日リマインド', explain:'直前', text:`本日 {{time}} に15分説明です。
入室：{{link}}`} ]
                    }
                }
            };
        }
        function seedQA(){
            return {
                'TikTok':{
                    '回答':[
                        {q:'顔出しは必須？', a:'TikTokは顔出しが主流ですが、画角や演出で調整可能です。参考：https://creators.tiktok.com/', explain:'最初は明るい場所・胸上の画角を推奨。顔出しが難しい場合は演出案を提示。'},
                        {q:'収益化の目安は？', a:'初月は企画・頻度次第。最初は目標を共有して進めます。', explain:'固定ファン化に向けたルーティン設計とイベント活用が鍵。'}
                    ],
                    '送信':[
                        {q:'顔出しは必須？', text:`顔出しが基本ですが、演出で工夫できます！\n一度、事例ベースでご紹介しますね。`},
                        {q:'収益化の目安', text:`企画と配信頻度で大きく変わります。\n初月の目標を一緒に設計しましょう！`}
                    ]
                },
                '17LIVE':{
                    '回答':[ {q:'イベント参加の頻度', a:'月2〜3回を目安に案件や露出に合わせて調整。', explain:'無理のない頻度で経験値を積む。'} ],
                    '送信':[ {q:'イベント頻度', text:`月2〜3回を目安に、露出や案件状況で調整します！`} ]
                },
                'ポコチャ':{
                    '回答':[ {q:'ランクはどう決まる？', a:'時間×盛り上がり指標で決まります。', explain:'盛り上がり=コメント/ギフト/視聴維持 などの総合。'} ],
                    '送信':[ {q:'ランクの仕組み', text:`時間×盛り上がりの合算で決まります。\n初期は習慣化→固定ファンづくりを一緒に！`} ]
                },
                'BIGOLIVE':{
                    '回答':[ {q:'海外リスナー対応', a:'英語/日本語のミックスでもOK。', explain:'翻訳と絵文字でのレスポンスも活用。'} ],
                    '送信':[ {q:'言語について', text:`海外リスナーも多いので、英語/日本語ミックスでOKです！`} ]
                },
                'WAVE':{
                    '回答':[ {q:'機材は必要？', a:'スマホ＋マイクでOK。Amazon等で安価なものからOK。', explain:'静かな環境とポップガードがあると尚良し。'} ],
                    '送信':[ {q:'機材について', text:`スマホとマイクがあれば始められます！`} ]
                }
            };
        }
        function seedInterview(){
            return {
                'TikTok':{ sheet:'', manual:'', columns: IV_DEFAULT_COLUMNS.slice(), flow:{ index:0, answers:{}, steps:[] } },
                '17LIVE':{ sheet:'', manual:'' },
                'ポコチャ':{ sheet:'', manual:'' },
                'BIGOLIVE':{ sheet:'', manual:'' },
                'WAVE':{ sheet:'', manual:'', columns: IV_DEFAULT_COLUMNS.slice(), flow:{ index:0, answers:{}, steps:[] } }
            };
        }

        // ===== Migrations / Ensurers =====
        function migrateTemplatesShape(){
            const t=DB.templates;
            if(!t) return;
            if(t.mode || (t.data && (t.data.face || t.data['no-face']))){
                const newData={};
                ['face','no-face'].forEach(m=>{
                    const src=t.data?.[m]||{};
                    Object.keys(src).forEach(app=>{
                        newData[app]=newData[app]||{};
                        const groups=src[app]||{};
                        Object.keys(groups).forEach(g=>{
                            newData[app][g]=newData[app][g]||[];
                            (groups[g]||[]).forEach(item=> newData[app][g].push(item));
                        });
                    });
                });
                DB.templates = {
                    app: t.app||'',
                    group: t.group||'スカウト',
                    step: t.step||0,
                    special:{ ttChoice:null, ttNote:'', ttConfirmRequired:false, ttConfirmText:'' },
                    data: newData
                };
                saveDB();
            }
            DB.templates.special = Object.assign({ttChoice:null, ttNote:'', ttConfirmRequired:false, ttConfirmText:''}, DB.templates.special||{});
        }

        // ---- TikTok登録：確認シナリオを保持 ----
        function ensureTTScenarios(){
            const tiktok = DB?.templates?.data?.['TikTok'];
            if (!tiktok) return;
            if (!tiktok._ttScenarios) {
                const seed = seedTemplates();
                tiktok._ttScenarios = clone(seed?.data?.['TikTok']?._ttScenarios || {});
            }
            if (!Array.isArray(tiktok['登録']) || !tiktok['登録'].length) {
                tiktok['登録'] = [{ title:'（選択待ち）', explain:'最初に上の「登録」内フローを選択してください。', text:'' }];
            }
            saveDB();
        }

        function migrateIvColumnsCommon(){
            const APPS = ['TikTok','WAVE'];
            APPS.forEach(app=>{
                const rec = DB.interview[app] || (DB.interview[app] = { sheet:'', manual:'', columns:[], flow:{index:0,answers:{},steps:[]} });
                const cols = Array.isArray(rec.columns) ? rec.columns : [];
                const same = cols.length === IV_DEFAULT_COLUMNS.length && cols.every((c,i)=> c === IV_DEFAULT_COLUMNS[i]);
                if(!same) rec.columns = IV_DEFAULT_COLUMNS.slice();
            });
            saveDB();
        }
        function ensureIvDefaults(){
            ['TikTok','WAVE'].forEach(app=>{
                const rec = DB.interview[app] || (DB.interview[app] = {sheet:'', manual:'', columns:[], flow:{index:0,answers:{},steps:[]}});
                if (!Array.isArray(rec.columns) || !rec.columns.length) rec.columns = IV_DEFAULT_COLUMNS.slice();
            });
            saveDB();
        }

        // ===== Load / Save =====
        function loadDB(){
            DB = JSON.parse(localStorage.getItem(KEYS.db)||'null') || JSON.parse(JSON.stringify(DefaultDB));
            if(!DB.templates) DB.templates = seedTemplates();
            if(!DB.qa || !Object.keys(DB.qa).length) DB.qa = seedQA();
            if(!DB.interview || !Object.keys(DB.interview).length) DB.interview = seedInterview();
            migrateTemplatesShape();
            ensureTTScenarios();
            ensureIvDefaults();
            migrateIvColumnsCommon();
        }
        // ===== Gate =====
        const gate = $('#gate'); const gatePass=$('#gatePass'); const gateBtn=$('#gateBtn');
        let expectedHash = null;
        function gateNeeded(){ return !!expectedHash && sessionStorage.getItem('noi_unlocked_'+expectedHash) !== '1'; }
        function updateGate(){ if(!gate) return; gate.style.display = gateNeeded() ? 'flex' : 'none'; if(gateNeeded()){ setTimeout(()=>gatePass && gatePass.focus(), 50); } }
        expectedHash = getFromHashOrQuery('h');
        async function tryUnlock(){
            const pass = (gatePass?.value||'').trim();
            if(!pass) return;
            const h = await sha256('noi-v1:'+pass);
            if(h === expectedHash){
                sessionStorage.setItem('noi_unlocked_'+h, '1');
                updateGate();
                showToast('解除しました');
                startRealtimeWhenReady(expectedHash);
            } else {
                showToast('合言葉が違います');
            }
        }
        // ===== UI Refs =====
        const appList=$('#appList'); const editorText=$('#textArea'); const explainEl=$('#explain'); const progress=$('#progress');
        const appNameEl=$('#appName'); const stepIndexEl=$('#stepIndex'); const stepTotalEl=$('#stepTotal');
        const stepTitleInput=$('#stepTitleInput'); const ttChoiceBox=$('#ttChoiceBox');

        // Q&A
        const qaAppList=$('#qaAppList'); const qaSegWrap=$('#qaSegWrap'); const qaList=$('#qaList'); const qaView=$('#qaView'); const qaEditor=$('#qaEditor');

        // Interview
        const ivAppList=$('#ivAppList'); const ivFormBox=$('#ivFormBox'); const ivEditor=$('#ivEditor');

        // ===== Tabs / MegaTabs =====
        let CURRENT_TAB = 'tpl';
        function switchTab(tab){
            CURRENT_TAB = tab;
            ['tpl','qa','interview'].forEach(id=> $('#tab_'+id).style.display = (id===tab) ? 'block':'none');
            localStorage.setItem('noi_tab', tab);
            renderMegaTabs();
        }
        function renderMegaTabs(){
            const wrap = $('#megaTabs'); if(!wrap) return;
            wrap.innerHTML = '';
            const order = ['スカウト','登録','end','Q&A','面談'];
            order.forEach(name=>{
                const btn=document.createElement('button'); btn.className='tab'; btn.textContent=name;
                const isTplGroup = ['スカウト','登録','end'].includes(name);
                const active = isTplGroup ? (CURRENT_TAB==='tpl' && DB.templates.group===name) :
                                           (name==='Q&A' ? CURRENT_TAB==='qa' : CURRENT_TAB==='interview');
                if(active) btn.classList.add('active');
                btn.onclick = ()=>{
                    if(isTplGroup){
                        DB.templates.group = name; DB.templates.step = 0; saveDB();
                        switchTab('tpl'); renderTplApps(); renderTplEditor();
                    }else{
                        if(name==='Q&A'){ switchTab('qa'); renderQaApps(); renderQaSeg(); renderQaList(); }
                        else { switchTab('interview'); renderIvApps(); renderIvForm(); }
                    }
                };
                wrap.appendChild(btn);
            });
        }

        // ===== Template helpers =====
        function tplApps(){ return Object.keys(DB.templates.data||{}); }
        function tplGroupList(){
            const a=DB.templates.data[DB.templates.app]||{};
            if(DB.templates.app==='TikTok' && DB.templates.group==='登録' && !DB.templates.special.ttChoice) return [];
            return a[DB.templates.group]||[];
        }

        function renderTplApps(){
            appList.innerHTML='';
            const apps=tplApps();
            apps.forEach(name=>{
                const b=document.createElement('button');
                b.className='app'+(DB.templates.app===name?' selected':'');
                const count=Object.values(DB.templates.data[name]||{}).reduce((n,arr)=>n+(arr?.length||0),0);
                b.innerHTML=`<span>${name}</span><span class="badge">${DB.templates.app===name?'選択中':count}</span>`;
                b.onclick=()=>{
                    DB.templates.app=name;
                    DB.templates.step=0;
                    DB.templates.special.ttChoice=null;
                    DB.templates.special.ttNote='';
                    DB.templates.special.ttConfirmRequired=false;
                    DB.templates.special.ttConfirmText='';
                    saveDB(); renderTplApps(); renderTplEditor();
                };
                appList.appendChild(b);
            });
        }

        // --- TikTok登録：確認カード ---
        function renderTTConfirm(){
            ttChoiceBox.style.display = 'block';
            ttChoiceBox.innerHTML = '';
            const card = document.createElement('div');
            card.className = 'panel';
            const body = escapeHtml(DB.templates.special.ttConfirmText || '');
            card.innerHTML = `
                <h3 style="margin:0 0 6px">確認事項</h3>
                <textarea id="ttConfirmText" style="min-height:120px">${body}</textarea>
                <div class="row" style="margin-top:8px;justify-content:flex-end;gap:8px">
                    <button class="btn ghost" id="ttBack">戻る</button>
                    <button class="btn primary" id="ttGo">進む</button>
                </div>`;
            ttChoiceBox.appendChild(card);

            $('#ttConfirmText').addEventListener('input', (e)=>{
                DB.templates.special.ttConfirmText = e.target.value || '';
                saveDB();
            });
            $('#ttBack').onclick = ()=>{
                DB.templates.special.ttChoice = null;
                DB.templates.special.ttConfirmRequired = false;
                DB.templates.special.ttConfirmText = '';
                if (DB.templates?.data?.['TikTok']){
                    DB.templates.data['TikTok']['登録'] = [{title:'（選択待ち）', explain:'最初に上の「登録」内フローを選択してください。', text:''}];
                }
                saveDB(); renderTplEditor();
            };
            $('#ttGo').onclick = ()=>{
                DB.templates.special.ttConfirmRequired = false; saveDB(); renderTplEditor();
            };
        }

        function renderTTChoice(){
            const isTikTokRegister = (DB.templates.app==='TikTok' && DB.templates.group==='登録');
            ttChoiceBox.style.display = isTikTokRegister ? 'block' : 'none';
            if (!isTikTokRegister) return;

            if (DB.templates.special.ttChoice && DB.templates.special.ttConfirmRequired){ renderTTConfirm(); return; }

            // ttChoiceが選択済みの場合
            if (DB.templates.special.ttChoice){
                // 何もしない（表示はrenderTplEditor()で行う）
                return;
            }

            // ttChoiceが未選択の場合
            ttChoiceBox.innerHTML = '';
            const options = [
                {key:'ttba_ok', title:'TTBA経由(アプリ内スカウト)でBackStageも登録可能の場合', note:true},
                {key:'sns_ok', title:'SNS等のスカウトでBackstageも登録可能な場合', note:true},
                {key:'agency_ng', title:'Backstage上でagency登録不可となっている場合', note:true},
                {key:'consider', title:'登録検討の場合', note:false},
                {key:'decline', title:'登録拒否の場合', note:false},
            ];
            const list=document.createElement('div'); list.className='apps';
            options.forEach(opt=>{
                const btn=document.createElement('button'); btn.className='app';
                btn.innerHTML=`<span>${opt.title}</span><span class="badge">選択</span>`;
                btn.onclick=()=>{
                    ensureTTScenarios();
                    const tiktok = DB.templates.data['TikTok'] || {};
                    const scenarios = tiktok._ttScenarios || {};
                    const src = clone(scenarios[opt.key] || []);
                    DB.templates.special.ttChoice = opt.key;
                    DB.templates.special.ttNote = '';
                    if (TT_CONFIRM_REQUIRED_KEYS.has(opt.key)){
                        DB.templates.special.ttConfirmRequired = true;
                        DB.templates.special.ttConfirmText = TT_CONFIRM_TEXT[opt.key] || '';
                    }else{
                        DB.templates.special.ttConfirmRequired = false;
                        DB.templates.special.ttConfirmText = '';
                    }
                    if (!DB.templates.data['TikTok']['登録']) DB.templates.data['TikTok']['登録'] = [];
                    DB.templates.data['TikTok']['登録'] = src;
                    DB.templates.step = 0; saveDB(); renderTplEditor();
                };
                list.appendChild(btn);
            });
            ttChoiceBox.appendChild(list);

            const showNote = document.createElement('div'); showNote.style.marginTop='10px';
            showNote.innerHTML = `
                <div class="note">上の3つを選ぶ場合は補足メモを残せます（テンプレ解説に表示）。</div>
                <textarea id="ttMemo" placeholder="補足メモ（任意）" style="min-height:90px;margin-top:6px"></textarea>`;
            ttChoiceBox.appendChild(showNote);
            $('#ttMemo').addEventListener('input', ()=>{
                DB.templates.special.ttNote = $('#ttMemo').value||''; saveDB();
            });
        }

        function renderTplEditor(){
            const list=tplGroupList();

            if(!DB.templates.app){
                appNameEl.textContent='未選択'; stepIndexEl.textContent='-'; stepTotalEl.textContent='-';
                stepTitleInput.value=''; explainEl.textContent='アプリを選択してください。';
                editorText.value=''; progress.innerHTML=''; $('#jumpList').innerHTML=''; $('#tplList').innerHTML='';
                renderTTChoice(); return;
            }

            renderTTChoice(); ensureTTScenarios();

            if (DB.templates.app==='TikTok' && DB.templates.group==='登録' && DB.templates.special.ttChoice && DB.templates.special.ttConfirmRequired){
                appNameEl.textContent=DB.templates.app+'｜'+DB.templates.group;
                stepIndexEl.textContent='-'; stepTotalEl.textContent='—';
                stepTitleInput.value=''; explainEl.innerHTML='上の「確認事項」を確認して <span class="kbd">進む</span> を押してください。';
                editorText.value=''; progress.innerHTML='';
                $('#prevBtn').disabled=true; $('#nextBtn').disabled=true;
                $('#jumpList').innerHTML=''; $('#tplList').innerHTML='';
                return;
            }

            appNameEl.textContent=DB.templates.app+'｜'+DB.templates.group;
            stepTotalEl.textContent=list.length || (DB.templates.app==='TikTok' && DB.templates.group==='登録' ? '—' : '0');

            if(!list.length){
                stepIndexEl.textContent='-';
                stepTitleInput.value='テンプレなし';
                explainEl.textContent = (DB.templates.app==='TikTok' && DB.templates.group==='登録' && !DB.templates.special.ttChoice)
                    ? '登録のフローを選択してください。' : 'このカテゴリにはテンプレがありません。＋で追加してください。';
                editorText.value=''; progress.innerHTML='';
                $('#prevBtn').disabled=true; $('#nextBtn').disabled=true;
                $('#jumpList').innerHTML=''; $('#tplList').innerHTML='';
                return;
            }

            DB.templates.step=Math.max(0,Math.min(DB.templates.step,list.length-1));
            stepIndexEl.textContent=DB.templates.step+1;

            const cur=list[DB.templates.step];

            stepTitleInput.value = cur.title || '';
            stepTitleInput.oninput = ()=>{ cur.title = stepTitleInput.value; saveDB(); };

            const memo = DB.templates.special?.ttNote || '';
            const explainText = (cur.explain||'').replace('{{memo}}', memo);
            explainEl.innerHTML = linkify(explainText);

            editorText.value=cur.text||'';

            $('#prevBtn').disabled=DB.templates.step===0;
            $('#nextBtn').disabled=DB.templates.step>=list.length-1;

            progress.innerHTML='';
            list.forEach((_,i)=>{
                const d=document.createElement('div'); d.className='dot'+(i===DB.templates.step?' on':'');
                d.onclick=()=>{DB.templates.step=i; saveDB(); renderTplEditor();};
                progress.appendChild(d);
            });
            const jump=$('#jumpList'); jump.innerHTML='';
            list.forEach((t,i)=>{
                const b=document.createElement('button'); b.className='tab'; b.textContent=t.title||`No.${i+1}`;
                b.onclick=()=>{DB.templates.step=i; saveDB(); renderTplEditor();}; if(i===DB.templates.step) b.classList.add('active'); jump.appendChild(b);
            });

            const wrap=$('#tplList'); wrap.innerHTML='';
            list.forEach((t,i)=>{
                const row=document.createElement('div'); row.className='panel';
                row.innerHTML=`
                    <div class="grid2"><input data-k="title" value="${(t.title||'').replace(/"/g,'&quot;')}"/><input data-k="explain" value="${(t.explain||'').replace(/"/g,'&quot;')}"/></div>
                    <textarea data-k="text">${(t.text||'').replace(/</g,'&lt;')}</textarea>
                    <div class="row" style="gap:8px;margin-top:8px">
                        <button class="btn danger" data-del="${i}">削除</button>
                    </div>`;
                wrap.appendChild(row);
                row.querySelectorAll('input,textarea').forEach(el=> el.oninput=()=>{ t[el.dataset.k]=el.value; saveDB(); });
                row.querySelector('[data-del]')?.addEventListener('click',()=>{ list.splice(i,1); saveDB(); renderTplEditor(); });
            });
        }

        // ===== Q&A =====
        let QA_APP = null; let QA_KIND = '回答';
        function qaApps(){ return Object.keys(DB.qa||{}); }
        function renderQaApps(){
            qaAppList.innerHTML=''; const apps=qaApps();
            if(!apps.length){ qaAppList.innerHTML='<p class="muted">Q&Aのデータがありません。編集モードで追加してください。</p>'; return; }
            if(!QA_APP) QA_APP=apps[0];
            apps.forEach(a=>{
                const b=document.createElement('button'); const count=(DB.qa[a]['回答']?.length||0)+(DB.qa[a]['送信']?.length||0);
                b.className='app'+(QA_APP===a?' selected':''); b.innerHTML=`<span>${a}</span><span class="badge">${count}</span>`;
                b.onclick=()=>{ QA_APP=a; renderQaApps(); renderQaSeg(); renderQaList(); }; qaAppList.appendChild(b);
            });
        }
        function renderQaSeg(){
            qaSegWrap.style.display= QA_APP? 'block':'none'; qaSegWrap.innerHTML='';
            if(!QA_APP) return;
            const wrap=document.createElement('div');
            wrap.style.cssText='display:grid;grid-template-columns:repeat(2,1fr);border:1px solid var(--line);border-radius:999px;overflow:hidden;';
            ['回答','送信'].forEach(kind=>{
                const btn=document.createElement('button'); const active=QA_KIND===kind;
                btn.style.cssText='background:none;color:var(--ink);border:none;padding:12px 14px;font-weight:800';
                btn.textContent=kind; if(active){ btn.classList.add('active'); btn.style.background='linear-gradient(135deg,#4f46e5,#7c3aed)'; btn.style.color='#fff'; }
                btn.onclick=()=>{ QA_KIND=kind; renderQaSeg(); renderQaList(); }; wrap.appendChild(btn);
            });
            qaSegWrap.appendChild(wrap);
        }
        function renderQaList(){
            qaList.innerHTML=''; qaView.innerHTML='';
            const items=DB.qa[QA_APP]?.[QA_KIND]||[];
            if(!items.length){ qaList.innerHTML='<p class="muted">項目がありません。編集モードで追加してください。</p>'; return; }
            const ul=document.createElement('div'); ul.style.display='grid'; ul.style.gap='8px';
            items.forEach((it,i)=>{
                const b=document.createElement('button'); b.className='app'; b.innerHTML=`<span>${escapeHtml(it.q||'')}</span>`;
                b.onclick=()=>{
                    if(QA_KIND==='回答'){
                        qaView.innerHTML = `
                            <div class="panel">
                                <h3 style="margin:0 0 6px">回答</h3>
                                <div>${linkify(it.a||'')}</div>
                                <div class="hr"></div>
                                <h4 style="margin:0 0 6px">解説</h4>
                                <div class="muted">${linkify(it.explain||'')}</div>
                            </div>`;
                    } else {
                        qaView.innerHTML = `
                            <div class="panel">
                                <h3 style="margin:0 0 6px">送信テンプレ</h3>
                                <div class="note" style="white-space:pre-wrap">${linkify(it.text||'')}</div>
                                <div class="row" style="margin-top:8px"><button class="btn copy" id="qaCopyBtn">コピー</button></div>
                            </div>`;
                        $('#qaCopyBtn').onclick=async()=>{ try{ await navigator.clipboard.writeText(it.text||''); showToast('コピーしました'); }catch{} };
                    }
                };
                ul.appendChild(b);
            });
            qaList.appendChild(ul);
        }
        function enableQaEdit(on){
            $('#qaEditor').style.display= on ? 'block':'none';
            $('#qaSave').style.display= on ? 'inline-flex':'none';
            $('#qaDiscard').style.display= on ? 'inline-flex':'none';
            if(on){
                qaEditor.innerHTML='';
                const apps=qaApps();
                const select=document.createElement('select');
                select.innerHTML=apps.map(a=>`<option ${a===QA_APP?'selected':''}>${a}</option>`).join('');
                select.onchange=()=>{ QA_APP=select.value; renderQaApps(); renderQaSeg(); renderQaList(); enableQaEdit(true); };
                qaEditor.appendChild(select);

                const kindSel=document.createElement('select');
                kindSel.innerHTML=['回答','送信'].map(k=>`<option ${k===QA_KIND?'selected':''}>${k}</option>`).join('');
                kindSel.onchange=()=>{ QA_KIND=kindSel.value; enableQaEdit(true); };
                qaEditor.appendChild(kindSel);

                const form=document.createElement('div'); form.className='panel';
                if(QA_KIND==='回答'){
                    form.innerHTML=`<div class="grid2"><input id="qaQ" placeholder="Q（質問）"/><input id="qaA" placeholder="回答（URL可）"/></div><textarea id="qaExplain" placeholder="解説（任意・URL可）"></textarea><div class="row" style="margin-top:8px"><button class="btn" id="qaAdd">＋ 追加</button></div>`;
                } else {
                    form.innerHTML=`<div class="grid2"><input id="qaQ" placeholder="Q（質問）"/></div><textarea id="qaText" placeholder="送信テンプレ本文（URL可）"></textarea><div class="row" style="margin-top:8px"><button class="btn" id="qaAdd">＋ 追加</button></div>`;
                }
                qaEditor.appendChild(form);
                $('#qaAdd').onclick=()=>{
                    const rec = (QA_KIND==='回答')? {q:$('#qaQ').value, a:$('#qaA').value, explain:$('#qaExplain').value} : {q:$('#qaQ').value, text:$('#qaText').value};
                    if(!rec.q) return; DB.qa[QA_APP][QA_KIND].push(rec); saveDB(); showToast('追加しました'); renderQaList(); enableQaEdit(true);
                };
                const items=DB.qa[QA_APP]?.[QA_KIND]||[]; const list=document.createElement('div'); list.style.marginTop='8px';
                items.forEach((it,i)=>{
                    const row=document.createElement('div'); row.className='panel';
                    if(QA_KIND==='回答'){
                        row.innerHTML=`<div class="grid2"><input data-k="q" value="${(it.q||'').replace(/\"/g,'&quot;')}"/><input data-k="a" value="${(it.a||'').replace(/\"/g,'&quot;')}"/></div><textarea data-k="explain">${(it.explain||'').replace(/</g,'&lt;')}</textarea><div class="row" style="gap:8px;margin-top:8px"><button class="btn danger" data-del="${i}">削除</button></div>`;
                    } else {
                        row.innerHTML=`<div class="grid2"><input data-k="q" value="${(it.q||'').replace(/\"/g,'&quot;')}"/></div><textarea data-k="text">${(it.text||'').replace(/</g,'&lt;')}</textarea><div class="row" style="gap:8px;margin-top:8px"><button class="btn danger" data-del="${i}">削除</button></div>`;
                    }
                    list.appendChild(row);
                    row.querySelectorAll('input,textarea').forEach(el=> el.oninput = ()=>{ it[el.dataset.k]=el.value; saveDB(); });
                    row.querySelector('[data-del]')?.addEventListener('click',()=>{ items.splice(i,1); saveDB(); enableQaEdit(true); renderQaList(); });
                });
                qaEditor.appendChild(list);
            }
        }

        // ===== Interview =====
        let IV_APP = null;
        function ivApps(){ return Object.keys(DB.interview||{}); }
        function renderIvApps(){
            ivAppList.innerHTML='';
            const apps=ivApps();
            if(!apps.length){ ivAppList.innerHTML='<p class="muted">面談データがありません。編集モードで追加してください。</p>'; return; }
            if(!IV_APP) IV_APP=apps[0];
            apps.forEach(a=>{
                const b=document.createElement('button');
                b.className='app'+(IV_APP===a?' selected':'');
                b.innerHTML=`<span>${a}</span>`;
                b.onclick=()=>{ IV_APP=a; renderIvApps(); renderIvForm(); };
                ivAppList.appendChild(b);
            });
        }
        function ivParseColumns(text){
            if(!text) return [];
            const first = String(text).split(/\r?\n/).find(s => s.trim().length) || '';
            const parts = first.includes('\t') ? first.split('\t') : first.split(',');
            return parts.map(s=>s.trim()).filter(Boolean);
        }
        function renderIvForm(){
            const box = ivFormBox;
            if (!IV_APP){ box.innerHTML = '<p class="muted">アプリを選択してください。</p>'; return; }
            const rec = DB.interview[IV_APP] || (DB.interview[IV_APP] = {sheet:'',manual:'',columns:[], flow:{index:0,answers:{},steps:[]}});

            box.innerHTML = '';
            if (!rec.columns || !rec.columns.length){
                const p = document.createElement('div');
                p.innerHTML = `
                    <div class="note">下のテキストにシートのヘッダー行を貼り付け→「列を設定」。</div>
                    <textarea id="ivColsRaw" placeholder="例：日時,氏名,アプリ,希望ジャンル,備考（カンマ/タブ区切りどちらでも可）" style="margin-top:8px;min-height:90px"></textarea>
                    <div class="row" style="margin-top:8px"><button class="btn" id="ivColsApply">列を設定</button></div>`;
                box.appendChild(p);
                $('#ivColsApply').onclick = ()=>{
                    const cols = ivParseColumns($('#ivColsRaw').value);
                    if(!cols.length){ showToast('列が読み取れませんでした'); return; }
                    rec.columns = cols; saveDB(); showToast('列を設定しました'); renderIvForm();
                };
                return;
            }

            const pillWrap = document.createElement('div');
            pillWrap.style.cssText='display:flex;gap:6px;flex-wrap:wrap;margin:6px 0';
            rec.columns.forEach(c=>{ const s=document.createElement('span'); s.className='pill'; s.textContent=c; pillWrap.appendChild(s); });
            box.appendChild(pillWrap);

            const inputs = document.createElement('div'); inputs.id='ivInputs';
            rec.columns.forEach(c=>{
                const row=document.createElement('div'); row.className='panel';
                row.innerHTML = `<label class="muted">${c}</label><input data-col="${c}">`;
                inputs.appendChild(row);
            });
            box.appendChild(inputs);

            const controls = document.createElement('div'); controls.className='row'; controls.style.cssText='margin-top:8px;justify-content:flex-end';
            controls.innerHTML = `
                <button class="btn copy small" id="ivCopyRow2">コピー</button>
                <button class="btn danger small" id="ivClearInputs2">リセット</button>
                <button class="btn ghost small" id="ivResetCols2">行設定</button>
                <button class="btn small" id="ivOpenSheet2">スプシ</button>`;
            box.appendChild(controls);

            const copyTSV = async ()=>{
                const values = rec.columns.map(c => (document.querySelector(`[data-col="${c}"]`)?.value || ''));
                const final = values.join('\t');
                try{ await navigator.clipboard.writeText(final); showToast('コピーしました'); }catch{ showToast('コピーに失敗'); }
            };
            const clearAll = ()=>{
                (rec.columns||[]).forEach(c=>{ const inp = document.querySelector(`[data-col="${c}"]`); if (inp) inp.value = ''; });
                if (IV_APP === 'WAVE' && rec.flow){ rec.flow.index = 0; rec.flow.answers = {}; }
                saveDB(); renderIvForm(); showToast('入力をリセットしました');
            };

            $('#ivCopyRow2').onclick = copyTSV;
            $('#ivClearInputs2').onclick = clearAll;
            $('#ivResetCols2').onclick = ()=>{
                box.innerHTML = `
                    <textarea id="ivColsRaw" style="min-height:90px">${rec.columns.join(', ')}</textarea>
                    <div class="row" style="margin-top:8px"><button class="btn" id="ivColsApply">列を設定</button></div>`;
                $('#ivColsApply').onclick = ()=>{
                    const cols = ivParseColumns($('#ivColsRaw').value);
                    if(!cols.length){ showToast('列が読み取れませんでした'); return; }
                    rec.columns = cols; saveDB(); showToast('列を設定しました'); renderIvForm();
                };
            };
            $('#ivOpenSheet2').onclick = ()=>{ if(rec.sheet) location.href = rec.sheet; else showToast('スプレッドシートURL未設定'); };

            const syncAnswersToInputs = ()=>{
                (rec.columns||[]).forEach(col=>{
                    const val = rec.flow?.answers?.[col] ?? '';
                    const inp = document.querySelector(`[data-col="${col}"]`);
                    if (inp && val && !inp.value) inp.value = val;
                });
            };
            if (IV_APP==='WAVE') syncAnswersToInputs();
        }

        function enableIvEdit(on){
            ivEditor.style.display = on ? 'block' : 'none';
            $('#ivSave').style.display = on ? 'inline-flex' : 'none';
            $('#ivDiscard').style.display = on ? 'inline-flex' : 'none';
            if(!on) return;

            const rec = DB.interview[IV_APP] || (DB.interview[IV_APP] = {sheet:'', manual:'', columns:[], flow:{index:0,answers:{},steps:[]}});

            ivEditor.innerHTML = `
                <input id="ivSheetUrl" placeholder="スプレッドシートURL" />
                <textarea id="ivManual" placeholder="面談マニュアル本文" style="min-height:120px"></textarea>
                <div class="note" style="margin-top:8px">WAVEの面談フロー（JSON）。<br>各ステップの <code>title/type/explain/options/column</code> を編集できます。</div>
                <textarea id="ivFlowJson" placeholder="WAVE用フロー（JSON配列）" style="min-height:220px"></textarea>`;
            $('#ivSheetUrl').value = rec.sheet || '';
            $('#ivManual').value = rec.manual || '';
            const steps = (rec.flow && Array.isArray(rec.flow.steps)) ? rec.flow.steps : [];
            $('#ivFlowJson').value = JSON.stringify(steps, null, 2);
        }

        // ===== Copy & Share (テンプレ) =====
        function applyTags(str){
            const map = { '{{name}}': $('#tagName')?.value, '{{date}}': $('#tagDate')?.value, '{{time}}': $('#tagTime')?.value, '{{link}}': $('#tagLink')?.value };
            let out = String(str ?? ''); for(const k in map){ const v = map[k]; if(v) out = out.split(k).join(v); } return out;
        }
        async function doCopy(){
            const txt = applyTags($('#textArea').value);
            try{ await navigator.clipboard.writeText(txt); showToast('コピーしました'); }
            catch(e){ const ta = $('#textArea'); ta.readOnly = false; ta.select(); document.execCommand('copy'); ta.readOnly = true; showToast('コピーしました（互換）'); }
        }
        async function doShare(){
            const txt = applyTags($('#textArea').value);
            if(navigator.share){ try{ await navigator.share({ text: txt }); }catch(e){} } else { showToast('共有に未対応の端末です'); }
        }

        // ===== Header buttons =====
        $('#installBtn').style.display='none'; let deferredPrompt=null;
        window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; $('#installBtn').style.display='inline-flex'; });
        $('#installBtn').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; $('#installBtn').style.display='none'; } else { showToast('iPhoneは共有→「ホーム画面に追加」'); } };
        $('#backupBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(DB)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='noi-backup.json'; a.click(); };
        $('#restoreBtn').onclick=()=> $('#restoreInput').click();
        $('#restoreInput').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); try{ const data=JSON.parse(txt); DB=data; saveDB(); showToast('読み込みました'); boot(); }catch{ showToast('JSONが不正です'); } });
        $('#protectBtn').onclick = async ()=>{ const pass=prompt('共有用の合言葉を入力してください（相手には別ルートで伝えてね）'); if(!pass) return; const h=await sha256('noi-v1:'+pass); const link=location.origin+location.pathname+'#h='+h; try{ await navigator.clipboard.writeText(link); showToast('共有リンクをコピーしました'); }catch{ showToast('リンク: '+link); } };

        // ===== Init & Boot =====
        function boot(){
            renderMegaTabs();
            const saved = localStorage.getItem('noi_tab'); const ok=['tpl','qa','interview'];
            switchTab(ok.includes(saved)? saved : 'tpl');

            // テンプレ
            renderTplApps(); renderTplEditor();
            $('#prevBtn').onclick=()=>{ const list=tplGroupList(); if(DB.templates.step>0){ DB.templates.step--; saveDB(); renderTplEditor(); } };
            $('#nextBtn').onclick=()=>{ const list=tplGroupList(); if(DB.templates.step<list.length-1){ DB.templates.step++; saveDB(); renderTplEditor(); } };
            $('#copyBtn').onclick=doCopy; $('#shareBtn').onclick=doShare;
            $('#tplEditor').style.display='block';

            $('#tplAdd').onclick=()=>{ const m=DB.templates.data[DB.templates.app]; if(!m) return; m[DB.templates.group]=m[DB.templates.group]||[]; m[DB.templates.group].push({title:'新しいテンプレ', explain:'説明', text:'本文'}); saveDB(); renderTplEditor(); };

            // Q&A
            renderQaApps(); renderQaSeg(); renderQaList();
            let qaEditing=false;
            $('#qaEditToggle').onclick=()=>{ qaEditing=!qaEditing; enableQaEdit(qaEditing); };
            $('#qaSave').onclick=()=>{ saveDB(); qaEditing=false; enableQaEdit(false); showToast('Q&Aを保存しました'); renderQaApps(); renderQaSeg(); renderQaList(); };
            $('#qaDiscard').onclick=()=>{ loadDB(); qaEditing=false; enableQaEdit(false); renderQaApps(); renderQaSeg(); renderQaList(); };

            // Interview
            renderIvApps(); renderIvForm();
            let ivEditing=false;
            $('#ivEditToggle').onclick=()=>{ ivEditing=!ivEditing; enableIvEdit(ivEditing); };
            $('#ivSave').onclick = ()=>{
                const rec = DB.interview[IV_APP] || (DB.interview[IV_APP] = {sheet:'', manual:'', columns:[], flow:{ index:0, answers:{}, steps:[] }});
                if ($('#ivSheetUrl')) rec.sheet = $('#ivSheetUrl').value;
                if ($('#ivManual')) rec.manual = $('#ivManual').value;
                if ($('#ivFlowJson')){
                    try{
                        const steps = JSON.parse($('#ivFlowJson').value || '[]');
                        if (!Array.isArray(steps)) throw new Error('steps is not array');
                        rec.flow = rec.flow || { index:0, answers:{}, steps:[] };
                        rec.flow.steps = steps;
                        const cols = steps.map(s=>s.column).filter(Boolean);
                        if (cols.length) rec.columns = cols;
                    }catch(e){ showToast('フローJSONの形式が不正です'); return; }
                }
                DB.interview[IV_APP] = rec; saveDB();
                showToast('面談を保存しました'); enableIvEdit(false); renderIvForm();
            };
            $('#ivDiscard').onclick=()=>{ loadDB(); enableIvEdit(false); renderIvApps(); renderIvForm(); };
        }

        // Gate
        expectedHash = getFromHashOrQuery('h');
        function tickGate(){ updateGate(); if(gateNeeded()) requestAnimationFrame(tickGate); }
        tickGate(); gateBtn?.addEventListener('click', tryUnlock); gatePass?.addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });

        // 起動
        loadDB(); boot();

        // すでに解除済みなら即同期開始
       if (expectedHash && sessionStorage.getItem('noi_unlocked_' + expectedHash) === '1') {
           startRealtimeWhenReady(expectedHash);
       }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js', { scope: './' })
                .then(() => console.log('SW registered'))
                .catch(e => console.warn('SW registration failed', e));
        }
    </script>
</body>
</html>